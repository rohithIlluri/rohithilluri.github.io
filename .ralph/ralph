#!/bin/bash
#
# Ralph Wiggum - Custom AI Development Loop for Portfolio Project
# "I'm helping!" - Ralph Wiggum
#
# A persistent iteration loop that feeds Claude Code the same prompt
# until completion, with strict planning and safety controls.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Load configuration
source "$SCRIPT_DIR/config.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# State tracking
ITERATION=0
START_TIME=$(date +%s)
LOG_FILE="$SCRIPT_DIR/logs/ralph-$(date +%Y%m%d-%H%M%S).log"

# Ensure log directory exists
mkdir -p "$SCRIPT_DIR/logs"

#######################################
# Logging functions
#######################################
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" >> "$LOG_FILE"

    case $level in
        INFO)  echo -e "${BLUE}[INFO]${NC} $message" ;;
        WARN)  echo -e "${YELLOW}[WARN]${NC} $message" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} $message" ;;
        SUCCESS) echo -e "${GREEN}[SUCCESS]${NC} $message" ;;
    esac
}

#######################################
# Display Ralph banner
#######################################
show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ____        __      __
   / __ \____ _/ /___  / /_
  / /_/ / __ `/ / __ \/ __ \
 / _, _/ /_/ / / /_/ / / / /
/_/ |_|\__,_/_/ .___/_/ /_/
             /_/
    Wiggum Loop v1.0
    "I'm helping!"
EOF
    echo -e "${NC}"
}

#######################################
# Check prerequisites
#######################################
check_prerequisites() {
    log INFO "Checking prerequisites..."

    # Check if claude is installed
    if ! command -v claude &> /dev/null; then
        log ERROR "Claude Code CLI not found. Install it first."
        exit 1
    fi

    # Check if prompt file exists
    if [[ ! -f "$PROMPT_FILE" ]]; then
        log ERROR "Prompt file not found: $PROMPT_FILE"
        log INFO "Create a prompt file or use: ralph init"
        exit 1
    fi

    # Check if rules file exists
    if [[ ! -f "$RULES_FILE" ]]; then
        log WARN "Rules file not found: $RULES_FILE"
        log INFO "Running without strict rules. Consider creating rules.md"
    fi

    log SUCCESS "Prerequisites check passed"
}

#######################################
# Check iteration limits
#######################################
check_limits() {
    # Check max iterations
    if [[ $ITERATION -ge $MAX_ITERATIONS ]]; then
        log WARN "Maximum iterations ($MAX_ITERATIONS) reached"
        return 1
    fi

    # Check time limit
    local current_time=$(date +%s)
    local elapsed=$((current_time - START_TIME))
    if [[ $elapsed -ge $MAX_TIME_SECONDS ]]; then
        log WARN "Maximum time limit (${MAX_TIME_SECONDS}s) reached"
        return 1
    fi

    # Check rate limit (simple cooldown)
    if [[ $ITERATION -gt 0 ]] && [[ $COOLDOWN_SECONDS -gt 0 ]]; then
        log INFO "Cooling down for ${COOLDOWN_SECONDS}s (rate limit protection)..."
        sleep $COOLDOWN_SECONDS
    fi

    return 0
}

#######################################
# Build the full prompt with rules
#######################################
build_prompt() {
    local prompt=""

    # Add rules if they exist
    if [[ -f "$RULES_FILE" ]]; then
        prompt+="# STRICT RULES - YOU MUST FOLLOW THESE\n\n"
        prompt+=$(cat "$RULES_FILE")
        prompt+="\n\n---\n\n"
    fi

    # Add iteration context
    prompt+="# ITERATION CONTEXT\n"
    prompt+="- Current iteration: $((ITERATION + 1)) of $MAX_ITERATIONS\n"
    prompt+="- Time elapsed: $(($(date +%s) - START_TIME)) seconds\n"
    prompt+="- Log file: $LOG_FILE\n\n"

    # Add the main prompt
    prompt+="# TASK\n\n"
    prompt+=$(cat "$PROMPT_FILE")

    # Add completion marker instruction
    prompt+="\n\n---\n\n"
    prompt+="# COMPLETION SIGNAL\n"
    prompt+="When you have FULLY completed the task, output exactly: $COMPLETION_MARKER\n"
    prompt+="Do NOT output this marker until ALL requirements are met.\n"

    echo -e "$prompt"
}

#######################################
# Run a single iteration
#######################################
run_iteration() {
    ITERATION=$((ITERATION + 1))
    log INFO "Starting iteration $ITERATION of $MAX_ITERATIONS"

    local prompt=$(build_prompt)
    local output_file="$SCRIPT_DIR/logs/iteration-${ITERATION}.log"

    # Run Claude Code
    if [[ "$DRY_RUN" == "true" ]]; then
        log INFO "[DRY RUN] Would execute claude with prompt"
        echo "$prompt" > "$output_file"
        return 0
    fi

    # Build claude command
    local claude_cmd="claude"

    if [[ "$DANGEROUSLY_SKIP_PERMISSIONS" == "true" ]]; then
        claude_cmd+=" --dangerously-skip-permissions"
    fi

    if [[ -n "$MODEL" ]]; then
        claude_cmd+=" --model $MODEL"
    fi

    claude_cmd+=" --print"

    # Execute and capture output
    log INFO "Executing Claude Code..."
    local output
    if output=$(echo "$prompt" | $claude_cmd 2>&1 | tee "$output_file"); then
        log SUCCESS "Iteration $ITERATION completed"
    else
        log ERROR "Iteration $ITERATION failed"
        return 1
    fi

    # Check for completion marker
    if echo "$output" | grep -q "$COMPLETION_MARKER"; then
        log SUCCESS "Completion marker found! Task complete."
        return 2  # Special return code for completion
    fi

    return 0
}

#######################################
# Main loop
#######################################
run_loop() {
    show_banner
    log INFO "Starting Ralph Wiggum loop"
    log INFO "Project: $PROJECT_ROOT"
    log INFO "Prompt file: $PROMPT_FILE"
    log INFO "Max iterations: $MAX_ITERATIONS"
    log INFO "Completion marker: $COMPLETION_MARKER"

    check_prerequisites

    while check_limits; do
        run_iteration
        local result=$?

        if [[ $result -eq 2 ]]; then
            # Task completed
            log SUCCESS "Ralph Wiggum completed the task in $ITERATION iterations!"
            show_summary
            exit 0
        elif [[ $result -ne 0 ]]; then
            log ERROR "Iteration failed, stopping loop"
            exit 1
        fi
    done

    log WARN "Loop ended without completion marker"
    show_summary
    exit 1
}

#######################################
# Show summary
#######################################
show_summary() {
    local end_time=$(date +%s)
    local total_time=$((end_time - START_TIME))

    echo ""
    echo -e "${CYAN}═══════════════════════════════════════${NC}"
    echo -e "${CYAN}         RALPH WIGGUM SUMMARY          ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════${NC}"
    echo -e "Iterations completed: ${GREEN}$ITERATION${NC}"
    echo -e "Total time: ${GREEN}${total_time}s${NC}"
    echo -e "Log file: ${BLUE}$LOG_FILE${NC}"
    echo -e "${CYAN}═══════════════════════════════════════${NC}"
}

#######################################
# Initialize ralph for a new task
#######################################
init_ralph() {
    log INFO "Initializing Ralph Wiggum for new task..."

    # Create prompt template if it doesn't exist
    if [[ ! -f "$SCRIPT_DIR/prompt.md" ]]; then
        cat > "$SCRIPT_DIR/prompt.md" << 'PROMPT_EOF'
# Task Description

[Describe your task here]

## Requirements

- [ ] Requirement 1
- [ ] Requirement 2
- [ ] Requirement 3

## Success Criteria

- All requirements implemented
- Tests passing
- No linting errors

## Notes

[Any additional context]
PROMPT_EOF
        log SUCCESS "Created prompt template: $SCRIPT_DIR/prompt.md"
    fi

    log SUCCESS "Ralph initialized! Edit prompt.md and run: ralph start"
}

#######################################
# Usage help
#######################################
show_help() {
    echo "Ralph Wiggum - AI Development Loop"
    echo ""
    echo "Usage: ralph <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start       Start the Ralph loop"
    echo "  init        Initialize Ralph for a new task"
    echo "  status      Show current status"
    echo "  logs        Show recent logs"
    echo "  help        Show this help message"
    echo ""
    echo "Options:"
    echo "  --dry-run           Don't actually run Claude, just show prompts"
    echo "  --max-iterations N  Override max iterations (default: $MAX_ITERATIONS)"
    echo "  --prompt FILE       Use custom prompt file"
    echo ""
    echo "Examples:"
    echo "  ralph init                    # Set up new task"
    echo "  ralph start                   # Start the loop"
    echo "  ralph start --dry-run         # Test without running Claude"
    echo "  ralph start --max-iterations 5"
}

#######################################
# Parse arguments and run
#######################################
main() {
    local command="${1:-help}"
    shift || true

    # Parse additional options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --dry-run)
                DRY_RUN="true"
                shift
                ;;
            --max-iterations)
                MAX_ITERATIONS="$2"
                shift 2
                ;;
            --prompt)
                PROMPT_FILE="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    case $command in
        start)
            run_loop
            ;;
        init)
            init_ralph
            ;;
        status)
            log INFO "Ralph Wiggum Status"
            log INFO "Project: $PROJECT_ROOT"
            log INFO "Prompt: $PROMPT_FILE"
            log INFO "Rules: $RULES_FILE"
            ;;
        logs)
            if [[ -d "$SCRIPT_DIR/logs" ]]; then
                ls -la "$SCRIPT_DIR/logs/"
            else
                log INFO "No logs yet"
            fi
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log ERROR "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
